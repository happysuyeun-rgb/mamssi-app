# 감정 기록 이미지 업로드 기능 테스트 가이드

## ✅ 코드 검토 결과

### 구현 상태
- ✅ 이미지 업로드 함수 (`uploadEmotionImage`) 구현 완료
- ✅ 이미지 삭제 함수 (`deleteEmotionImage`) 구현 완료
- ✅ 유효성 검사 (파일 크기, 타입) 구현 완료
- ✅ 에러 처리 및 명확한 에러 메시지 구현 완료
- ✅ 이미지 미리보기 UI 구현 완료
- ✅ 이미지 삭제 버튼 구현 완료
- ✅ 기존 이미지 수정/삭제 로직 구현 완료

### 확인된 기능
1. **파일 검증**
   - 파일 크기: 10MB 이하
   - 파일 타입: 이미지 파일만 (image/*)
   - 에러 메시지: 명확한 안내

2. **업로드 프로세스**
   - 경로 규칙: `{userId}/{uuid}.{extension}`
   - Storage 버킷: `emotion-images`
   - Public URL 생성
   - DB 저장: `emotions.image_url`

3. **에러 처리**
   - 버킷 없음: 명확한 메시지 + 해결 방법 안내
   - 권한 에러: 명확한 메시지
   - 네트워크 에러: 일반 에러 메시지

---

## 🧪 기능 테스트 체크리스트

### 사전 준비
- [ ] Supabase Dashboard > Storage에서 `emotion-images` 버킷 확인
- [ ] 버킷이 없으면 `create_emotion_images_bucket.sql` 실행
- [ ] 브라우저 새로고침 또는 앱 재시작

### 테스트 1: 기본 이미지 업로드
- [ ] `/record` 접속
- [ ] 감정 선택 (예: 기쁨 😊)
- [ ] 내용 입력
- [ ] "📷 사진 추가" 버튼 클릭
- [ ] 이미지 파일 선택 (JPG, 5MB 이하)
- [ ] 이미지 미리보기 표시 확인 (56x56px 썸네일)
- [ ] "저장" 버튼 클릭
- [ ] 콘솔에서 `[uploadEmotionImage] 파일 업로드 성공` 로그 확인
- [ ] Supabase Dashboard > Storage > `emotion-images`에서 파일 확인
- [ ] Supabase Dashboard > `emotions` 테이블에서 `image_url` 확인
- [ ] 성공 토스트 메시지 확인
- [ ] 홈 화면으로 리다이렉트 확인

**예상 결과**: ✅ 이미지 업로드 성공, DB 저장 성공, 홈 화면 이동

### 테스트 2: 이미지 개수 제한 ⭐ 신규 기능
- [ ] 이미지 0개 상태에서 이미지 1개 추가 → 성공 확인
- [ ] 이미지 1개 상태에서 이미지 1개 더 추가 (총 2개) → 성공 확인
- [ ] 이미지 2개 상태에서 이미지 추가 시도 → 경고 메시지: "이미지는 최대 2개까지 첨부할 수 있어요 ⚠️"
- [ ] 이미지 2개 상태에서 추가 불가 확인
- [ ] 이미지 1개 삭제 후 다시 추가 가능한지 확인
- [ ] 여러 파일 선택 시 남은 슬롯만큼만 추가되고 경고 메시지 표시 확인
- [ ] 안내 문구에 "최대 2개" 표시 확인

**예상 결과**: ✅ 이미지 개수 제한 정상 동작

### 테스트 3: 이미지 미리보기 및 삭제
- [ ] 기록 화면에서 이미지 선택
- [ ] 이미지 미리보기 표시 확인
- [ ] 미리보기 썸네일의 X 버튼 클릭
- [ ] 미리보기 제거 확인
- [ ] 저장 버튼 클릭
- [ ] 이미지 없이 기록 저장 확인

**예상 결과**: ✅ 이미지 미리보기 제거, 기록 저장 성공

### 테스트 4: 파일 크기 검증
- [ ] 기록 화면에서 "📷 사진 추가" 클릭
- [ ] 10MB 초과 이미지 선택
- [ ] 경고 메시지 확인: "10MB 이하의 이미지만 첨부할 수 있어요 ⚠️"
- [ ] 업로드가 진행되지 않음 확인

**예상 결과**: ✅ 경고 메시지 표시, 업로드 차단

### 테스트 5: 파일 타입 검증
- [ ] 기록 화면에서 "📷 사진 추가" 클릭
- [ ] 텍스트 파일(.txt) 선택
- [ ] 경고 메시지 확인 또는 파일 선택 불가 확인

**예상 결과**: ✅ 이미지 파일만 선택 가능

### 테스트 6: 기존 기록 이미지 수정
- [ ] 이미지가 있는 기존 기록 선택
- [ ] 기록 수정 화면 진입
- [ ] 기존 이미지 미리보기 표시 확인
- [ ] "📷 사진 추가" 버튼 클릭
- [ ] 새 이미지 선택
- [ ] 새 이미지 미리보기 표시 확인
- [ ] "수정 완료" 버튼 클릭
- [ ] 콘솔에서 기존 이미지 삭제 로그 확인
- [ ] Supabase Dashboard > Storage에서 기존 이미지 삭제 확인
- [ ] 새 이미지 업로드 확인
- [ ] `emotions.image_url` 업데이트 확인

**예상 결과**: ✅ 기존 이미지 삭제, 새 이미지 업로드, DB 업데이트

### 테스트 7: 기존 기록 이미지 삭제
- [ ] 이미지가 있는 기존 기록 선택
- [ ] 기록 수정 화면 진입
- [ ] 기존 이미지 미리보기 표시 확인
- [ ] 미리보기 썸네일의 X 버튼 클릭
- [ ] 이미지 미리보기 제거 확인
- [ ] "수정 완료" 버튼 클릭
- [ ] `emotions.image_url = null` 확인 (Supabase Dashboard에서 확인)

**예상 결과**: ✅ 이미지 미리보기 제거, DB에서 image_url null 처리

### 테스트 7: 버킷 없음 에러 처리
- [ ] `emotion-images` 버킷 삭제 (또는 존재하지 않는 상태)
- [ ] 기록 화면에서 이미지 업로드 시도
- [ ] 에러 메시지 확인: "Storage 버킷 'emotion-images'이 존재하지 않거나 접근할 수 없어요..."
- [ ] 해결 방법 안내 확인: "(create_emotion_images_bucket.sql 실행)"

**예상 결과**: ✅ 명확한 에러 메시지, 해결 방법 안내

---

## 📊 테스트 결과 기록

### 통과한 테스트
- [ ] 테스트 1: 기본 이미지 업로드
- [ ] 테스트 2: 이미지 미리보기 및 삭제
- [ ] 테스트 3: 파일 크기 검증
- [ ] 테스트 4: 파일 타입 검증
- [ ] 테스트 5: 기존 기록 이미지 수정
- [ ] 테스트 6: 기존 기록 이미지 삭제
- [ ] 테스트 7: 버킷 없음 에러 처리

### 실패한 테스트
- [ ] [테스트 항목] - [실패 이유]

### 발견된 이슈
1. [이슈 설명]
   - 재현 단계:
   - 예상 결과:
   - 실제 결과:
   - 스크린샷:

---

## 🔍 디버깅 팁

### 콘솔 로그 확인
다음 로그들이 정상적으로 출력되는지 확인:
- `[uploadEmotionImage] 파일 업로드 성공`
- `[uploadEmotionImage] Public URL 생성 완료`
- `[Record] 감정 기록 저장 성공`

### Supabase Dashboard 확인
1. **Storage > emotion-images**
   - 파일이 `{userId}/{uuid}.{extension}` 형식으로 저장되는지 확인
   
2. **Table Editor > emotions**
   - `image_url` 필드에 Public URL이 저장되는지 확인

### 에러 발생 시
1. 콘솔 에러 메시지 확인
2. Supabase Dashboard > Storage에서 버킷 존재 확인
3. RLS 정책 확인 (`create_emotion_images_bucket.sql` 재실행)

---

## ✅ 테스트 완료 기준

모든 테스트가 통과하면:
- ✅ 이미지 업로드 성공
- ✅ 이미지 미리보기 정상
- ✅ 이미지 삭제 정상
- ✅ 유효성 검사 정상
- ✅ 에러 처리 정상
- ✅ DB 저장 정상

---

## 다음 단계

테스트 완료 후:
1. [ ] 발견된 이슈 수정
2. [ ] 재테스트 진행
3. [ ] 프로덕션 배포 준비
